version: "3"

dotenv:
  - .env

vars:
  SYNC_DB_DSN: "{{.SYNC_DATABASE_URL}}"

tasks:
  help:
    desc: print this help message
    cmds:
      - task --list-all
    silent: true

  confirm:
    desc: confirmation prompt
    cmds:
      - |
        echo -n 'Are you sure? [y/N] ' && read ans && [ ${ans:-N} = y ]
    silent: true
    internal: true

  run:auth:
    desc: run the cmd/sync application with Taskfile watch auto-reload
    cmds:
      - echo "Starting sync application..."
      - "bunx kill-port 8081"
      - go run cmd/auth/main.go
    watch: true
    sources:
      - "**/*.go"

  run:events:
    desc: run the cmd/events application with Taskfile watch auto-reload
    cmds:
      - echo "Starting events service..."
      - "bunx kill-port 8082"
      - go run cmd/events/main.go
    watch: true
    sources:
      - "**/*.go"

  migrations:new:
    desc: create a new Goose migration
    vars:
      NAME: '{{.name | default ""}}'
    cmds:
      - |
        if [ -z "{{.NAME}}" ]; then
          echo "Error: name parameter is required"
          echo "Usage: task migrations:new name=migration_name"
          exit 1
        fi
      - echo "Creating Goose migration file for {{.NAME}}..."
      - goose -dir ./internal/db/migrations create {{.NAME}} sql

  migrations:up:
    desc: apply all up database migrations using Goose
    cmds:
      - echo 'Running up migrations for sync...'
      - goose -dir ./internal/db/migrations postgres "{{.SYNC_DATABASE_URL}}" up

  migrations:down:
    desc: roll back last migration
    cmds:
      - echo 'Rolling back last migration for sync...'
      - goose -dir ./internal/db/migrations postgres "{{.SYNC_DATABASE_URL}}" down

  tidy:
    desc: format all .go files and clean/tidy dependencies
    cmds:
      - echo 'Formatting .go files...'
      - go fmt ./...
      - echo 'Tidying module dependencies...'
      - go mod tidy
      - echo 'Verifying dependencies...'
      - go mod verify
